<!doctype html><html lang=en-us><head><title>your database connection deserves a name - Andy Grunwald</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Andy Grunwald"><meta name=description content="Assigning a name to your database connection can lower your time to debug. We provide an overview of how to do this for various database systems."><meta name=keywords content="Database,Lessons learned,Engineering,Programming,PHP,Go,Redis,RabbitMQ,PostgreSQL,Best practice"><meta property="og:title" content="your database connection deserves a name"><meta property="og:description" content="Assigning a name to your database connection can lower your time to debug. We provide an overview of how to do this for various database systems."><meta property="og:type" content="article"><meta property="og:url" content="https://andygrunwald.com/blog/your-database-connection-deserves-a-name/"><meta property="og:image" content="https://andygrunwald.com/img/posts/your-connection-deserves-a-name/assign-a-name-to-your-connection.png"><meta property="og:image" content="https://andygrunwald.com/img/posts/your-connection-deserves-a-name/perfect-engineering-world-vs-reality-shared-database.png"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-07-25T08:30:00+02:00"><meta property="article:modified_time" content="2021-07-25T08:30:00+02:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://andygrunwald.com/img/posts/your-connection-deserves-a-name/assign-a-name-to-your-connection.png"><meta name=twitter:title content="your database connection deserves a name"><meta name=twitter:description content="Assigning a name to your database connection can lower your time to debug. We provide an overview of how to do this for various database systems."><meta name=twitter:site content="@andygrunwald"><meta name=twitter:creator content="@andygrunwald"><meta name=robots content="index,follow"><meta name=googlebot content="index,follow"><link rel=canonical href=https://andygrunwald.com/blog/your-database-connection-deserves-a-name/><link rel=stylesheet href=https://andygrunwald.com/css/main.css><link rel="shortcut icon" type=image/x-icon href=https://andygrunwald.com/favicon.ico><link rel=apple-touch-icon sizes=57x57 href=https://andygrunwald.com/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=https://andygrunwald.com/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=https://andygrunwald.com/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=https://andygrunwald.com/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=https://andygrunwald.com/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=https://andygrunwald.com/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=https://andygrunwald.com/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=https://andygrunwald.com/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=https://andygrunwald.com/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=https://andygrunwald.com/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=https://andygrunwald.com/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=https://andygrunwald.com/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=https://andygrunwald.com/favicon-16x16.png><link rel=manifest href=https://andygrunwald.com/site.webmanifest><meta name=msapplication-TileColor content="#ffffff"><meta name=msapplication-TileImage content="https://andygrunwald.com/ms-icon-144x144.png"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/solid.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/brands.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/fontawesome.min.css><link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic" rel=stylesheet type=text/css></head><body><header class=site-header><div class=branding><a href=https://andygrunwald.com/><img class=avatar src=https://andygrunwald.com/img/avatar.png alt=avatar></a><h1 class=site-title><a href=https://andygrunwald.com/>Andy Grunwald</a></h1></div><nav class=site-nav><ul><li><a href=https://andygrunwald.com/>Blog</a></li><li><a href=https://andygrunwald.com/about/>About</a></li><li class=icon><a href=https://andygrunwald.com/index.xml title=Subcribe><i class="fas fa-fw fa-rss"></i></a></li><li class=icon><a href=mailto:andygrunwald@gmail.com title=Email><i class="fas fa-fw fa-envelope"></i></a></li><li class=icon><a href=https://github.com/andygrunwald rel=me title=GitHub><i class="fab fa-fw fa-github"></i></a></li><li class=icon><a href=https://www.linkedin.com/in/andy-grunwald-09aa265a rel=me title=LinkedIn><i class="fab fa-fw fa-linkedin"></i></a></li><li class=icon><a href=https://twitter.com/andygrunwald rel=me title=Twitter><i class="fab fa-fw fa-twitter"></i></a></li><li class=icon><a href=https://meetup.com/Web-Engineering-Duesseldorf/ rel=me title=Meetup><i class="fab fa-fw fa-meetup"></i></a></li></ul></nav></header><div class=content><article><header><h1 class=title>your database connection deserves a name</h1><p class=meta>July 25, 2021 &#183; 4 minute read
&#183; Tags:
<a href=https://andygrunwald.com/tags/engineering/>Engineering</a>
, <a href=https://andygrunwald.com/tags/lessons-learned/>Lessons learned</a>
, <a href=https://andygrunwald.com/tags/programming/>Programming</a></p></header><section class=post-content><figure><img src=https://andygrunwald.com/img/posts/your-connection-deserves-a-name/assign-a-name-to-your-connection.png alt="Provide a name to your database connection"></figure><p><strong>tl;dr</strong>: When your app interacts with an external system (e.g., a database), <strong>assign a name to the connection</strong>.
The goal should be: <strong>the external system knows who you are</strong>.
During an incident, it will reduce the time to debug by multiple hours and often save other applications from failing.</p><p>Most of the applications on this planet interact with some datastore (used as a synonym for things like a database, cache, queuing system).
In a perfect (engineering) world:</p><ul><li>Every application has its own datastore</li><li>Datastores are not shared across applications</li><li>Direct access to the stored data is shielded by an application (e.g., an API)</li></ul><p>The thing is: We don&rsquo;t live in a perfect (engineering) world.
The reality is like this:</p><ul><li>Several applications share one or multiple datastore</li><li>These applications get independent developed from each other</li><li>and even may receive different types of traffic patterns</li></ul><p>This leads to a situation where one application requests many datastore resources (e.g., through traffic spikes or expensive and inefficient queries).
At the same time, all other applications might suffer from unexpected behavior or a (partial) outage due to limited resources available on the datastore to serve the requests.</p><figure><img src=https://andygrunwald.com/img/posts/your-connection-deserves-a-name/perfect-engineering-world-vs-reality-shared-database.png alt="A perfect (engineering) world where everyone has its own datastore vs. Reality where datastores are shared."><figcaption><p>A perfect (engineering) world where everyone has its own datastore vs. Reality where datastores are shared.</p></figcaption></figure><p>This situation is typically hard to debug because the root cause is not that obvious:
Application B is failing because the datastore cannot answer in time due to Application A sending expensive requests.</p><p>If you are in control of the applications, assigning a name to each connected client wise can help to</p><ul><li>lower the debugging pain and reduce the time to recover in an outage</li><li>collect usage/resource metrics from the perspective of the datastore over each application</li></ul><h2 id=how-helpful-is-this-in-reality>How helpful is this in reality?</h2><p>In my last eight years working mainly on the reliability of <a href=https://www.trivago.com/>trivago</a>, connection naming has helped us multiple times to find the root cause faster.
We saw:</p><ul><li>blocked Redis instances</li><li>blocked database tables due to inefficient queries</li><li>overloaded database servers due to traffic spikes</li></ul><p>In all cases, identifying the client was the main entry point for the solution.</p><h2 id=what-is-a-good-connection-name>What is a good connection name?</h2><p>In general, everything to identify who sends the request or query.
Two quick suggestions:</p><p><strong>If you control all applications and datastores</strong>, choose the name of the application itself.
If the application opens several connections, add another identifier like a package or a class name.</p><p><strong>If you don&rsquo;t own the datastore or operate with an external service</strong>, use the application name followed by some contact information.
In case of trouble, the operator will reach out.</p><h2 id=how-to-assign-a-name-to-a-connection>How to assign a name to a connection</h2><p>This depends on the system you are using.
Below you find instructions for</p><ul><li><a href=#how-to-assign-a-name-to-your-redis-connection>redis</a></li><li><a href=#how-to-assign-a-name-to-your-rabbitmq-connection>RabbitMQ</a></li><li><a href=#how-to-assign-a-name-to-your-postgresql-connection>PostgreSQL</a></li><li><a href=#how-to-assign-a-name-to-your-http-connection>HTTP</a></li></ul><p>Keep in mind: Not every datastore supports this.
Once supported, it is usually straightforward to assign a name to a connection without any engineering overhead.</p><p>In <a href=https://github.com/andygrunwald/your-connection-deserves-a-name title="Code examples on how to name a connection for Redis, RabbitMQ, PostgreSQL and more">andygrunwald/your-connection-deserves-a-name @ Github</a> I provide complete examples for different programming languages and systems on how to assign a name to a connection.</p><h3 id=-with-redis>&mldr; with redis</h3><p>After creating a connection to redis, send the <a href=https://redis.io/commands/client-setname title="CLIENT SETNAME @ redis docs"><code>CLIENT SETNAME</code></a> command:</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>CLIENT SETNAME currency-conversion-app
</code></pre></div><p>Via <a href=https://redis.io/commands/client-list title="CLIENT LIST @ redis docs"><code>CLIENT LIST</code></a> you can see all clients, including their name:</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ CLIENT LIST
<span style=color:#bb60d5>id</span><span style=color:#666>=</span><span style=color:#40a070>3</span> <span style=color:#bb60d5>addr</span><span style=color:#666>=</span>172.17.0.1:61516 <span style=color:#bb60d5>name</span><span style=color:#666>=</span>currency-conversion-app <span style=color:#666>[</span>...<span style=color:#666>]</span>
</code></pre></div><p>➡️ Checkout <a href=https://github.com/andygrunwald/your-connection-deserves-a-name/tree/main/redis>screenshots and code examples for redis at Github</a>.</p><h3 id=-with-rabbitmq>&mldr; with RabbitMQ</h3><p>While creating a connection to RabbitMQ, you can provide AMQP options.
One of the options is <a href=https://www.rabbitmq.com/connections.html#client-provided-names title="AMQP Client-Provided Connection Name @ RabbitMQ docs"><code>connection_name</code></a>.</p><p>This is how it looks like in Go:</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>config <span style=color:#666>:=</span> amqp.Config{
    Properties: amqp.Table{
        <span style=color:#4070a0>&#34;connection_name&#34;</span>: <span style=color:#4070a0>&#34;currency-conversion-app&#34;</span>,
    },
}
conn, err <span style=color:#666>:=</span> amqp.<span style=color:#06287e>DialConfig</span>(<span style=color:#4070a0>&#34;amqp://guest:guest@127.0.0.1:5672/&#34;</span>, config)
</code></pre></div><p>In the UI of Rabbit under the Connection tab, you can see all connected clients, including their names:</p><figure><img src=https://andygrunwald.com/img/posts/your-connection-deserves-a-name/rabbitmq-connection-client-name.png alt="RabbitMQ Connections: Showing clients name under the IP address"><figcaption><p>RabbitMQ Connections: Showing clients name under the IP address</p></figcaption></figure><p>➡️ Checkout <a href=https://github.com/andygrunwald/your-connection-deserves-a-name/tree/main/rabbitmq>screenshots and code examples for RabbitMQ at Github</a>.</p><h3 id=-with-postgresql>&mldr; with PostgreSQL</h3><p>While creating a connection to PostgreSQL, you can provide a client name in the connection string.
The property is called <a href=https://www.postgresql.org/docs/9.0/runtime-config-logging.html#GUC-APPLICATION-NAME><code>application_name</code></a> and is part of <a href=https://www.postgresql.org/docs/9.0/libpq-connect.html>libpq</a>.</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>dsn <span style=color:#666>:=</span> <span style=color:#4070a0>&#34;postgres://user:pass@127.0.0.1/database?application_name=currency-conversion-app&#34;</span>
conn, err <span style=color:#666>:=</span> sql.<span style=color:#06287e>Open</span>(<span style=color:#4070a0>&#34;postgres&#34;</span>, dsn)
</code></pre></div><p>To see which clients are connected (incl. their application name), you can query the <code>pg_stat_activity</code> table:</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql>postgres<span style=color:#666>=#</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>SELECT</span><span style=color:#bbb> </span>usename,<span style=color:#bbb> </span>application_name,<span style=color:#bbb> </span>client_addr,<span style=color:#bbb> </span>backend_type<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>FROM</span><span style=color:#bbb> </span>pg_stat_activity;<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb> </span>usename<span style=color:#bbb>  </span><span style=color:#666>|</span><span style=color:#bbb>    </span>application_name<span style=color:#bbb>     </span><span style=color:#666>|</span><span style=color:#bbb> </span>client_addr<span style=color:#bbb> </span><span style=color:#666>|</span><span style=color:#bbb> </span>backend_type<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#60a0b0;font-style:italic>----------+-------------------------+-------------+----------------
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb> </span>postgres<span style=color:#bbb> </span><span style=color:#666>|</span><span style=color:#bbb> </span>currency<span style=color:#666>-</span><span style=color:#007020;font-weight:700>conversion</span><span style=color:#666>-</span>app<span style=color:#bbb> </span><span style=color:#666>|</span><span style=color:#bbb> </span><span style=color:#40a070>172</span>.<span style=color:#40a070>17</span>.<span style=color:#40a070>0</span>.<span style=color:#40a070>1</span><span style=color:#bbb>  </span><span style=color:#666>|</span><span style=color:#bbb> </span>client<span style=color:#bbb> </span>backend<span style=color:#bbb>
</span></code></pre></div><p>➡️ Checkout <a href=https://github.com/andygrunwald/your-connection-deserves-a-name/tree/main/postgresql>screenshots and code examples for PostgreSQL at Github</a>.</p><h3 id=-with-http>&mldr; with HTTP</h3><p>The <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/User-Agent title="User-Agent at Mozilla Developer Network">User-Agent HTTP header field</a> was explicitly created for this use-case:</p><blockquote><p>[&mldr;] string that lets servers and network peers identify the application, operating system, vendor, and/or version [&mldr;]</p></blockquote><p>How the value looks is not specified.
Here are a few suggestions:</p><ul><li><a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/User-Agent title="User-Agent at Mozilla Developer Network">Mozilla Developer Network</a>: <code>&lt;product> / &lt;product-version> &lt;comment></code></li><li><a href=https://www.mediawiki.org/wiki/API:Etiquette#The_User-Agent_header title="API:Etiquette of MediaWiki">MediaWiki</a>: <code>clientname/version (contact information e.g. username, email)</code></li><li><a href=https://docs.github.com/en/rest/overview/resources-in-the-rest-api#user-agent-required title="User-Agent section @ GitHub API docs">GitHub API</a>: your GitHub username, or the name of your application</li></ul><p>➡️ Checkout <a href=https://github.com/andygrunwald/your-connection-deserves-a-name/tree/main/http>screenshots and code examples for HTTP at Github</a>.</p><h2 id=you-know-a-system-that-supports-connection-naming>You know a system that supports connection naming?</h2><p>I would love to hear from you.
Contribute to <a href=https://github.com/andygrunwald/your-connection-deserves-a-name>andygrunwald/your-connection-deserves-a-name @ GitHub</a> via an Issue or Pull Request.</p></section></article><div class="comments related-posts"><h3>Continue reading</h3><ul><li><a href=https://andygrunwald.com/blog/migrate-your-local-php-7.2-setup-to-homebrew-v1.5./>Migrate your local PHP 7.2 setup to Homebrew v1.5.*</a></li><li><a href=https://andygrunwald.com/blog/resources-to-learn-golang/>Resources to learn Go(lang)</a></li><li><a href=https://andygrunwald.com/blog/learn-redis-the-hard-way-in-production-trivago-techblog/>Learn Redis the hard way (in production) @ trivago techblog</a></li></ul></div></div><footer class=site-footer><p class=text>&copy; 2021 - Andy Grunwald</p></footer><script type=application/javascript>var dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes",GA_SESSION_STORAGE_KEY;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),window.sessionStorage&&(GA_SESSION_STORAGE_KEY='ga:clientId',ga('create','UA-64342623-1',{storage:'none',clientId:sessionStorage.getItem(GA_SESSION_STORAGE_KEY)}),ga(function(a){sessionStorage.setItem(GA_SESSION_STORAGE_KEY,a.get('clientId'))})),ga('set','anonymizeIp',!0),ga('send','pageview'))</script></body></html>